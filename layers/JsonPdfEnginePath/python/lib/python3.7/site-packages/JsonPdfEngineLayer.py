from os import walk
from os.path import join
from pathlib import Path

from json import load, dumps
from functools import lru_cache

from pybars import Compiler
from selenium import webdriver

HTML_CONF = {
    "ext": ".hbs",
    "layouts_dir": "/opt/layouts",
    "partials_dir": "/opt/components"
}

PHANTOM_ENV = {
    "executable_path": "node_modules/phantomjs-prebuilt/lib/phantom/bin/phantomjs", 
    "service_log_path": "/tmp/ghostdriver.log"
}

PDF_CONF = {
    "script_path": "node_modules/phantomjs-prebuilt/lib/phantomjs.js",
    "output": "/tmp/output.pdf"
}


def files():
    for r, d, f in walk(HTML_CONF['partials_dir']):
        for file in f:
            if HTML_CONF['ext'] in file:
                yield join(r, file)


def file_read(file):
    with open(file) as f:
        return f.read()


def name(file): return Path(file).stem


def data_compile(file):
    data_source = file_read(file)
    return Compiler().compile(data_source)


@lru_cache(maxsize=128)
def partials_build():
    return {
        'partials': {name(file): data_compile(file) for file in files()}
    }


@lru_cache(maxsize=128)
def template_build(layout_name):
    file = join(HTML_CONF['layouts_dir'], layout_name + HTML_CONF['ext'])
    
    template = data_compile(file)
    partials = partials_build()
    
    return lambda data: template(data, **partials)


def pdf_build(html, env=PHANTOM_ENV):
    def execute(script, args):
        driver.execute(PDF_CONF["script_path"], {'script': script, 'args': args})

    driver = webdriver.PhantomJS(**env)        
    driver.command_executor._commands[PDF_CONF["script_path"]] = (
        'POST', '/session/$sessionId/phantom/execute'
    )

    page_content = f'''this.content = '{html}';'''
    execute(page_content, [])
        
    page_format = 'this.paperSize = {format: "A4", orientation: "portrait" };'
    execute(page_format, [])

    render = '''this.render("{}")'''.format(PDF_CONF["output"])
    execute(render, [])

